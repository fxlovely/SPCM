#!/bin/sh -e

##########################################################################
#   Script description:
#       
#   Arguments:
#       
#   Returns:
#       
#   History:
#   Date        Name        Modification
#   2015-06-16  root        Begin
##########################################################################

usage()
{
    printf "Usage: $0 hostname\n"
    exit 1
}


##########################################################################
#   Main
##########################################################################

if [ $# != 1 ]; then
    usage
fi

node=$1

case `uname` in
Linux)
    # Prevent node from being enabled in the scheduler

    printf "Run cluster-init-node? [y]/n "
    read resp
    if [ 0$resp != 0n ]; then
	printf "Gateway? "
	read gateway
	cluster-init-node $node $gateway
    fi
    
    ssh $node cp /usr/pkg-1/etc/cshrc /etc/profile.d/pkgsrc.csh
    ssh $node cp /usr/pkg-1/etc/shrc /etc/profile.d/pkgsrc.sh
    
    # Sync users
    # FIXME: Don't assume slurm
    node-sync-user $node slurm || true
    printf "Sync users? [y]/n "
    read sync
    if [ 0$sync != 0n ]; then
	node-sync-all-users $node
    fi
    
    # Sync sys files
    cluster-sync-sysfiles $node
    
    printf "Sync custom files? [y]/n "
    read sync
    if [ 0$sync != 0n ]; then
	cluster-sync-files
    fi
    
    # hosts.allow
    rsync -av /etc/hosts.allow $node:/etc
    
    # Other stuff
    
    # Sync software
    
    # Run cluster-setup compute
    # Do this last, since it enables the scheduler
    ssh -t $node cluster-setup compute
    ;;
*)
    printf "Not yet implemented for `uname`.\n"
    exit 1
    ;;
esac

# Reboot

