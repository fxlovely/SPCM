#!/bin/sh -e

##########################################################################
#   Function description:
#       Pause until user presses return
##########################################################################

pause()
{
    local junk
    
    printf "Press return to continue..."
    read junk
}

sinfo_format='%T %u %E %N'
resp=''
while [ 0$resp != 0q ]; do
    clear
    cat << EOM
    
			     **********************
				SLURM Admin Menu
			     **********************

1.. Restart scheduler daemons
2.. Drain a node
3.. Resume a node
4.. Show cores per user
5.. Show cluster load
6.. Resume all updated nodes currently marked down
7.. Scan for stray processes
Q.. Quit

EOM

    printf 'Selection? '
    read resp
    case $resp in
    1)
	slurm-restart
	pause
	;;
    2)
	clear
	printf "Current node status:\n\n"
	sinfo -o "$sinfo_format"
	printf "\nNode number? (e.g. 001) "
	read node
	if [ 0$node != 0 ]; then
	    printf "Reason? "
	    read reason
	    scontrol update State=drain NodeName=compute-$node reason="$reason"
	    sinfo --list-reasons
	    printf "Update slurm.conf if this is a long-term outage.\n"
	    pause
	fi
	;;
    3)
	clear
	printf "Nodes currently down:\n\n"
	sinfo --list-reasons
	printf "\nNode number? (e.g. 001) "
	read node
	if [ 0$node != 0 ]; then
	    full_name=`awk '$3 == "compute-'$node'" { print $2 }' /etc/hosts`
	    slurm-resume-nodes $full_name
	    pause
	fi
	;;
    4)
	slurm-user-cores
	pause
	;;
    5)
	slurm-cluster-load
	pause
	;;
    6)
	slurm-resume-updated-nodes
	sinfo
	pause
	;;
    7)
	printf "Username of user with suspected strays? "
	read username
	slurm-find-strays $username
	pause
	;;
    Q|q)
	;;
    *)
	printf "Invalid selection: $resp\n"
	pause
    esac
done

