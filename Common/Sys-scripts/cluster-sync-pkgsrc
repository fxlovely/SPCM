#!/bin/sh -e

##########################################################################
#   Script description:
#       
#   Arguments:
#       
#   Returns:
#       
#   History:
#   Date        Name        Modification
#   2016-05-06  root        Begin
##########################################################################

usage()
{
    printf "Usage: $0 [backup|compute|io node [... node]]\n"
    exit 1
}


##########################################################################
#   Main
##########################################################################

case $# in
0)
    compute_nodes=`cluster-compute-nodes`
    other_nodes="`cluster-backup-login-nodes` `cluster-io-nodes`"
    ;;
1)
    usage
    ;;
*)
    case $1 in
    io|backup)
	shift
	other_nodes="$@"
	compute_nodes=""
	;;
    compute)
	shift
	compute_nodes="$@"
	other_nodes=""
	;;
    *)
	usage
	;;
    esac
esac

# Caution: 
# The line below is modified by install.sh. Be careful not to replace
# %%PREFIX%% or %%SRC_PREFIX%% with a hard-coded prefix from an installed
# script.
prefix=%%PREFIX%%
src_prefix=%%SRC_PREFIX%%

auto-clean-pkgsrc $src_prefix

for node in $other_nodes; do
    printf "$node...\n"
    if ! rsync -av --delete $prefix $src_prefix ${node}:/usr; then
	failed_nodes="$failed_nodes $node"
    else
	ssh $node cp $prefix/etc/pkgsrc.\*sh /etc/profile.d
    fi
done

for node in $compute_nodes; do
    printf "$node...\n"
    if ! rsync -av --delete $prefix ${node}:/usr; then
	failed_nodes="$failed_nodes $node"
    else
	ssh $node cp $prefix/etc/pkgsrc.\*sh /etc/profile.d
    fi
done

if [ ! -z $failed_nodes ]; then
    printf "Unable to sync the following nodes: %s\n" "$failed_nodes"
fi

