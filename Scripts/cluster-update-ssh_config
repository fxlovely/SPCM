#!/bin/sh -e

ssh_config='/etc/ssh/ssh_config'
if [ ! -e $ssh_config.orig ]; then
    cp $ssh_config $ssh_config.orig
    cp $ssh_config $ssh_config.tail
else
    # Strip out the old rules and keep the rest
    marker='# Original ssh_config'
    fgrep -A 1000000 "$marker" $ssh_config | \
	fgrep -v "$marker" > $ssh_config.tail
fi

cat << EOM > $ssh_config
######################################################################
# This file is generated by $0 from $ssh_config.orig.
# If you want to make custom changes, alter $ssh_config.orig and
# re-run $0.
#
# This section was added by $0
#
EOM

for host in `cluster-head-node` `cluster-compute-nodes`; do
    # Need short name for code that follows
    host=`echo $host | cut -d '.' -f 1`
    
    printf "Host $host\n" >> $ssh_config
    printf "    StrictHostKeyChecking no\n" >> $ssh_config
    
    # FQHN
    fqhn=`awk '$3 == "'$host'" { printf("%s ", $2) }' /etc/hosts | awk ' { print $1 }'`
    printf "Host $fqhn\n" >> $ssh_config
    printf "    StrictHostKeyChecking no\n" >> $ssh_config
    
    # IP
    ip=`awk '$3 == "'$host'" { printf("%s ", $1) }' /etc/hosts | awk ' { print $1 }'`
    printf "Host $ip\n" >> $ssh_config
    printf "    StrictHostKeyChecking no\n\n" >> $ssh_config
done

# Uncomment "Host *" header in original and append to new
printf "# Original ssh_config:\n" >> $ssh_config
sed 's/\# Host \*/Host \*/g' $ssh_config.tail >> $ssh_config

