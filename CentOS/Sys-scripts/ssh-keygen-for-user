#!/bin/sh -e

##########################################################################
#   Script description:
#       
#   Arguments:
#       
#   Returns:
#       
#   History:
#   Date        Name        Modification
#   2014-01-05  root        Begin
##########################################################################

usage()
{
    printf "Usage: $0 username\n"
    exit 1
}


##########################################################################
#   Main
##########################################################################

if [ $# != 1 ]; then
    usage
fi

user_name=$1

if [ ! -e /home/$user_name/.ssh ]; then
    mkdir -m 0700 /home/$user_name/.ssh
fi

chown -Rh $user_name /home/$user_name/.ssh

# Generated by cluster-setup
if [ ! -f /home/$user_name/.ssh/id_rsa ]; then
    sudo -u $user_name ssh-keygen -f /home/$user_name/.ssh/id_rsa -N ""
fi

if [ ! -f /home/$user_name/.ssh/authorized_keys ]; then
    cat /home/$user_name/.ssh/id_rsa.pub > /home/$user_name/.ssh/authorized_keys
    chmod 600 /home/$user_name/.ssh/authorized_keys
    chmod 600 /home/$user_name/.ssh/id_rsa
    chmod 644 /home/$user_name/.ssh/id_rsa.pub
fi

group=`awk -F : -v user_name=$user_name '$1 == user_name { print $4 }' /etc/passwd`

chown -Rh ${user_name}:$group /home/$user_name/.ssh

