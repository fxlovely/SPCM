#!/bin/sh -e


##########################################################################
#   Function description:
#       Pause until user presses return
##########################################################################

pause()
{
    local junk
    
    printf "Press return to continue..."
    read junk
}

prefix=/usr/pkg-1
yum install httpd php

ganglia=/var/lib/ganglia
mkdir -p $ganglia/rrds
chown nobody:nobody $ganglia/rrds/
restorecon -R -v $ganglia

ganglia_web=/var/lib/ganglia-web
cp -Rp $prefix/$ganglia_web /var/lib
chown -R apache:apache $ganglia_web
chmod -R u+rwX,g-w $ganglia_web

# selinux attempted fixes
#chcon -R -t httpd_sys_rw_content_t $ganglia_web
#setsebool -P allow_httpd_sys_script_anon_write 1
#restorecon -R -v $ganglia_web
#setsebool -P allow_httpd_anon_write=1
# FIXME: Temporary hack
echo 0 > /selinux/enforce

DATADIR=$prefix/share/cluster-admin
cp $DATADIR/WWW/global_styles.css $DATADIR/WWW/centos-power.jpg /var/www/html
chmod a+r /var/www/html/*

if [ ! -e /var/www/html/index.php ]; then
    printf "Cluster name as it should appear on the web? "
    read name
    sed -e "s|%%HOSTNAME%%|$name|g" $DATADIR/WWW/index.php > /var/www/html/index.php
fi

for service in gmond gmetad; do
    if [ ! -e $prefix/etc/$service.conf ]; then
	cp $prefix/share/examples/ganglia-monitor-core/$service.conf $prefix/etc
    fi
    vi $prefix/etc/$service.conf
    chmod 644 $prefix/etc/$service.conf

    ln -sf $prefix/share/examples/ganglia-monitor-core/$service.init.linux /etc/init.d/$service
    chkconfig --add $service
    chkconfig $service on       # probably redundant
    service $service restart
    pause
done

httpd_conf='/etc/httpd/conf/httpd.conf'

if ! fgrep -q '/ganglia/' $httpd_conf; then

    cat << EOM >> $httpd_conf

Alias /ganglia/ "$prefix/share/httpd/htdocs/ganglia/"

<Directory "$prefix/share/httpd/htdocs/ganglia/">
    Options Indexes FollowSymlinks MultiViews
    AllowOverride None
    Order allow,deny
    Allow from all
    <IfModule dir_module>
	DirectoryIndex index.php
    </IfModule>
</Directory>
EOM
fi

chkconfig --add httpd
chkconfig httpd on
service httpd restart

