#!/bin/sh

# From http://nullworks.wordpress.com/2012/09/26/infiniband-on-centos-6-3/
# See also http://sonicostech.wordpress.com/2012/02/23/howto-infiniband-srp-target-on-centos-6-incl-rpm-spec/

yum -y install srptools rdma

# This is just a bonus to make it easier to find our local info if iinfiniband-diags is installed.
echo -n `uname -n` > /sys/class/infiniband/mlx4_0/node_desc

# Untested beyond here.  Move exit below latest tested segment.
exit

vi /etc/rdma/rdma.conf
SRP_LOAD=yes

chkconfig rdma on
chkconfig srpd on

service rdma start
service srpd start

#---- Using srp_daemon ---#
srp_daemon -e -o
# or
srp_daemon -c -a -o -i mlx4_0 -p 1 -e
srp_daemon -c -a -o -i mlx4_0 -p 2 -e
#-------------------------#

#---- Manually ---#
ibsrpdm -c
id_ext=xxxxxxxxxxxxxxxxxx,ioc_guid=xxxxxxxxxxxxxxxxxx,dgid=xxxxxxxxxxxxxxxxx,pkey=ffff,service_id=xxxxxxxxxxxxxxxxxx

## Do this twice, once to get the session to show on the violin memory, and again after exporting the lun to the group to get the LUN to show up
echo -n id_ext=xxxxxxxxxxxxxxxxxx,ioc_guid=xxxxxxxxxxxxxxxxxx,dgid=xxxxxxxxxxxxxxxxx,pkey=ffff,service_id=xxxxxxxxxxxxxxxxxx > /sys/class/infiniband_srp/srp-mlx4_0-1/add_target
#-----------------#

## Setup multipath alias
# get wwid
multipath -ll

vi /etc/multipath.conf
multipaths {
    multipath {
	wwid 12345678901234567890(Use your WWID)
	alias lun01
    }
}

# Flush and reload multipath
service multipathd stop
multipath -F
service multipathd start
multipath -v2
multipath -ll

mount /dev/mapper/lun01p1 /mnt/lun01

# If LUN has an existing partition and is not showing up, run partprobe
partprobe /dev/mapper/lun01

